@using HeatconERP.Web.Services
@inject ApiClient Api
@inject AuthService Auth
@inject NavigationManager Nav
@inject IConfiguration Config

<PageTitle>Login - HeatconERP</PageTitle>

<div style="position: fixed; inset: 0; display: flex; width: 100vw; height: 100vh;" class="bg-[#0a0f18]">
        <!-- Left (Brand) -->
        <div style="flex: 1; display: flex; align-items: center; justify-content: center;" class="border-r border-[#344465] bg-[#0a0f18]">
            <div class="px-10">
                <div class="text-[11px] uppercase tracking-[0.35em] font-bold text-slate-400">Heatcon</div>
                <div class="mt-3 text-5xl font-extralight text-white leading-none">Heatcon</div>
                <div class="mt-3 text-sm text-slate-500">Manufacturing ERP System</div>
            </div>
        </div>

        <!-- Right (Login form) -->
        <div style="flex: 1; display: flex; align-items: center; justify-content: center;" class="bg-[#111621]">
            <div class="w-full max-w-md px-10">
                <div class="mb-6">
                    <div class="text-xs font-bold uppercase tracking-wider text-slate-200">Login</div>
                    <div class="text-[11px] text-slate-500 mt-1">Enter your credentials to continue.</div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] uppercase tracking-wider font-bold text-slate-500 block mb-1">Username</label>
                        <input type="text"
                               class="w-full bg-[#243047] border border-[#344465] rounded text-xs py-2 px-2 text-slate-200"
                               @bind="_username" @bind:event="oninput" />
                    </div>

                    <div>
                        <label class="text-[10px] uppercase tracking-wider font-bold text-slate-500 block mb-1">Password</label>
                        <input type="password"
                               class="w-full bg-[#243047] border border-[#344465] rounded text-xs py-2 px-2 text-slate-200"
                               @bind="_password" @bind:event="oninput" />
                    </div>

                    @if (!string.IsNullOrEmpty(_error))
                    {
                        <div class="p-3 border border-rose-500/20 bg-rose-900/15 text-rose-300 text-xs">@_error</div>
                    }

                    <button type="button"
                            class="w-full px-4 py-2 rounded font-bold text-xs text-white bg-[#195de6] hover:bg-[#195de6]/90 disabled:opacity-60 disabled:cursor-not-allowed"
                            disabled="@_loading"
                            @onclick="HandleLogin">
                        @(_loading ? "Logging in..." : "Login")
                    </button>
                </div>
            </div>
        </div>
</div>

@code {
    private string _username = "";
    private string _password = "";
    private string? _error;
    private bool _loading;

    protected override void OnInitialized()
    {
        // Always use configured API base URL (do not expose in UI).
        var configured = Config["ApiBaseUrl"];
        if (!string.IsNullOrWhiteSpace(configured))
            Auth.SetBaseUrl(configured);
    }

    private async Task HandleLogin()
    {
        _error = null;
        _loading = true;
        StateHasChanged();

        try
        {
            var apiUrl = Auth.BaseUrl;
            if (string.IsNullOrWhiteSpace(apiUrl))
                apiUrl = (Config["ApiBaseUrl"] ?? "http://localhost:5212").TrimEnd('/');

            var (user, error) = await Api.LoginAsync(apiUrl, _username, _password);

            if (user != null)
            {
                await Auth.LoginAsync(user, apiUrl);
                Nav.NavigateTo("/dashboard");
            }
            else
            {
                _error = error ?? "Login failed.";
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }
}
