@using HeatconERP.Web.Services
@inject ApiClient Api
@inject AuthService Auth
@inject NavigationManager Nav

<PageTitle>Login - HeatconERP</PageTitle>

<div class="login-container">
    <div class="login-card">
        <h1 class="login-title">HeatconERP</h1>
        <p class="login-subtitle">Manufacturing ERP</p>

        <div>
            <div class="mb-3">
                <label class="form-label">API URL</label>
                <input type="text" class="form-control" placeholder="http://localhost:5212"
                       @bind="_apiUrl" @bind:event="oninput" />
            </div>
            <div class="mb-3">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" @bind="_username" @bind:event="oninput" />
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" class="form-control" @bind="_password" @bind:event="oninput" />
            </div>
            @if (!string.IsNullOrEmpty(_error))
            {
                <div class="alert alert-danger mb-3">@_error</div>
            }
            <button type="button" class="btn btn-primary" disabled="@_loading" @onclick="HandleLogin">@(_loading ? "Logging in..." : "Login")</button>
        </div>
    </div>
</div>

@code {
    private string _apiUrl = "http://localhost:5212";
    private string _username = "";
    private string _password = "";
    private string? _error;
    private bool _loading;

    private async Task HandleLogin()
    {
        _error = null;
        _loading = true;
        StateHasChanged();

        try
        {
            var (user, error) = await Api.LoginAsync(_apiUrl, _username, _password);

            if (user != null)
            {
                await Auth.LoginAsync(user, _apiUrl);
                Nav.NavigateTo("/dashboard");
            }
            else
            {
                _error = error ?? "Login failed.";
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }
}
