@page "/production"
@using HeatconERP.Web.Services
@using HeatconERP.Web.Models
@inject AuthService Auth
@inject ApiClient Api

<PageTitle>Production - HeatconERP</PageTitle>

<div class="mb-6 flex items-center justify-between">
    <h2 class="text-lg font-bold uppercase tracking-wider text-slate-100 flex items-center gap-2">
        <span class="material-symbols-outlined text-[#195de6]">factory</span>
        Production
    </h2>
    <div class="flex gap-2">
        <select class="bg-[#243047] border border-[#344465] text-slate-200 text-xs px-3 py-2 uppercase font-medium" @bind="_filterStage" @bind:after="LoadAsync">
            <option value="">All Stages</option>
            <option value="Planning">Planning</option>
            <option value="Material">Material</option>
            <option value="Assembly">Assembly</option>
            <option value="Testing">Testing</option>
            <option value="QC">QC</option>
            <option value="Packing">Packing</option>
        </select>
        <button class="px-3 py-2 bg-[#195de6] text-white text-xs font-bold uppercase" @onclick="LoadAsync">
            <span class="material-symbols-outlined text-sm align-middle">refresh</span> Refresh
        </button>
    </div>
</div>

@if (_loading)
{
    <div class="flex items-center justify-center p-12 text-slate-400">Loading...</div>
}
else
{
    <div class="bg-[#243047]/20 border border-[#344465] overflow-hidden">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-[#111621]/50 border-b border-[#344465] text-[10px] uppercase font-bold text-slate-500">
                    <th class="px-4 py-3">Order #</th>
                    <th class="px-4 py-3">Stage</th>
                    <th class="px-4 py-3">Status</th>
                    <th class="px-4 py-3">Created</th>
                    <th class="px-4 py-3 text-right">Action</th>
                </tr>
            </thead>
            <tbody class="text-xs text-slate-300">
                @if (_workOrders.Count == 0)
                {
                    <tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">No work orders in production.</td></tr>
                }
                else
                {
                    @foreach (var wo in _workOrders)
                    {
                        <tr class="border-b border-[#344465]/30 hover:bg-[#243047]/30 transition-colors">
                            <td class="px-4 py-3 font-bold text-[#195de6]">@wo.OrderNumber</td>
                            <td class="px-4 py-3"><span class="px-2 py-0.5 bg-[#243047] border border-[#344465] uppercase text-[9px]">@wo.Stage</span></td>
                            <td class="px-4 py-3">@wo.Status</td>
                            <td class="px-4 py-3 text-slate-400">@wo.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                            <td class="px-4 py-3 text-right">
                                <select class="bg-[#243047] border border-[#344465] text-slate-200 text-[10px] px-2 py-1" @onchange="e => UpdateStage(wo.Id, e.Value?.ToString())">
                                    <option value="" selected disabled>Move to...</option>
                                    <option value="Planning">Planning</option>
                                    <option value="Material">Material</option>
                                    <option value="Assembly">Assembly</option>
                                    <option value="Testing">Testing</option>
                                    <option value="QC">QC</option>
                                    <option value="Packing">Packing</option>
                                </select>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<WorkOrderDto> _workOrders = [];
    private string _filterStage = "";
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        StateHasChanged();
        var baseUrl = Auth.BaseUrl;
        var items = await Api.GetProductionWorkOrdersAsync(baseUrl, string.IsNullOrEmpty(_filterStage) ? null : _filterStage);
        _workOrders = items?.ToList() ?? [];
        _loading = false;
        StateHasChanged();
    }

    private async Task UpdateStage(Guid id, string? stage)
    {
        if (string.IsNullOrEmpty(stage)) return;
        var ok = await Api.UpdateWorkOrderStageAsync(Auth.BaseUrl, id, stage);
        if (ok) await LoadAsync();
    }
}
