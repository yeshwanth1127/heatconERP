@page "/dashboard"
@using HeatconERP.Web.Services
@using HeatconERP.Web.Models
@inject AuthService Auth
@inject ApiClient Api

<PageTitle>Dashboard - HeatconERP</PageTitle>

@if (_loading)
{
    <div class="flex items-center justify-center p-12">
        <span class="text-slate-400">Loading dashboard...</span>
    </div>
}
else
{
    var role = Auth.CurrentUser?.Role ?? "";
    if (role == "ProductionManager")
    {
        <div class="bg-[#1a2233] border border-[#344465] mb-6">
            <div class="px-6 py-4 border-b border-[#344465] flex items-center justify-between gap-4">
                <div>
                    <div class="text-xs text-slate-400 uppercase tracking-widest font-bold">Production Manager</div>
                    <div class="text-xl font-bold text-white leading-none mt-1">Analytics Dashboard</div>
                </div>
                <button class="bg-[#243047] hover:bg-[#344465] border border-[#344465] text-slate-300 py-2 px-4 text-xs font-bold rounded flex items-center gap-2" @onclick="RefreshAsync">
                    <span class="material-symbols-outlined text-sm">refresh</span> Refresh
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-[#243047]/25 border border-[#344465] p-4">
                <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500 mb-2">New Received Orders</div>
                <div class="text-3xl font-light text-white">@_pmNewCount</div>
                <div class="text-[11px] text-slate-500 mt-1">Sent from CRM, awaiting acceptance</div>
            </div>
            <div class="bg-[#243047]/25 border border-[#344465] p-4">
                <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500 mb-2">Accepted</div>
                <div class="text-3xl font-light text-white">@_pmAcceptedCount</div>
                <div class="text-[11px] text-slate-500 mt-1">Acknowledged by production</div>
            </div>
            <div class="bg-[#243047]/25 border border-[#344465] p-4">
                <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500 mb-2">All Sent</div>
                <div class="text-3xl font-light text-white">@_pmAllSentCount</div>
                <div class="text-[11px] text-slate-500 mt-1">Total dispatches from CRM</div>
            </div>
            <div class="bg-[#243047]/25 border border-[#344465] p-4">
                <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500 mb-2">Active Work Orders</div>
                <div class="text-3xl font-light text-white">@_pmActiveProductionCount</div>
                <div class="text-[11px] text-slate-500 mt-1">From production module (active)</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-6">
            @if (!string.IsNullOrWhiteSpace(_pmQualityDeleteError))
            {
                <div class="lg:col-span-12 p-3 border border-rose-500/20 bg-rose-900/10 text-rose-300 text-xs">
                    @_pmQualityDeleteError
                </div>
            }
            <div class="lg:col-span-4 bg-[#111621] border border-[#344465] overflow-hidden flex flex-col min-h-[320px]">
                <div class="p-3 border-b border-[#344465] bg-[#243047]/30 flex items-center justify-between">
                    <div class="text-xs font-bold uppercase tracking-wider text-slate-100 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm text-[#195de6]">fact_check</span>
                        Awaiting QC
                    </div>
                    <div class="text-[11px] text-slate-500">@_pmAwaitingQc.Count</div>
                </div>
                <div class="flex-1 overflow-auto industrial-scrollbar p-3 space-y-2">
                    @if (_pmAwaitingQc.Count == 0)
                    {
                        <div class="text-slate-500 text-sm p-4">No work orders awaiting QC.</div>
                    }
                    else
                    {
                        @foreach (var wo in _pmAwaitingQc.Take(30))
                        {
                            <div class="border border-[#344465] bg-[#243047]/10 p-3 flex items-center justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-xs font-bold text-[#195de6] truncate">@wo.WorkOrderNumber</div>
                                    <div class="text-[11px] text-slate-500 mt-1">Stage: <span class="text-slate-200 font-semibold">@wo.CurrentStage</span> · Gate: <span class="text-amber-300 font-semibold">@wo.CurrentGateStatus</span></div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <a class="px-2 py-1 bg-[#195de6] hover:bg-[#195de6]/90 text-white text-[10px] font-bold uppercase rounded"
                                       href="@($"/quality?woId={wo.WorkOrderId}")">Inspect</a>
                                    <button class="px-2 py-1 bg-[#243047] hover:bg-[#344465] border border-[#344465] text-slate-200 text-[10px] font-bold uppercase rounded"
                                            @onclick="() => DeleteQualityAsync(wo.WorkOrderId)">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            <div class="lg:col-span-4 bg-[#111621] border border-[#344465] overflow-hidden flex flex-col min-h-[320px]">
                <div class="p-3 border-b border-[#344465] bg-[#243047]/30 flex items-center justify-between">
                    <div class="text-xs font-bold uppercase tracking-wider text-slate-100 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm text-rose-400">error</span>
                        Failed QC / Open NCR
                    </div>
                    <div class="text-[11px] text-slate-500">@_pmFailedOpenNcr.Count</div>
                </div>
                <div class="flex-1 overflow-auto industrial-scrollbar p-3 space-y-2">
                    @if (_pmFailedOpenNcr.Count == 0)
                    {
                        <div class="text-slate-500 text-sm p-4">No open NCRs.</div>
                    }
                    else
                    {
                        @foreach (var wo in _pmFailedOpenNcr.Take(30))
                        {
                            <div class="border border-rose-500/20 bg-rose-900/10 p-3 flex items-center justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-xs font-bold text-rose-300 truncate">@wo.WorkOrderNumber</div>
                                    <div class="text-[11px] text-slate-500 mt-1">Stage: <span class="text-slate-200 font-semibold">@wo.CurrentStage</span> · NCR: <span class="text-rose-300 font-semibold">Open</span></div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <a class="px-2 py-1 bg-rose-600 hover:bg-rose-500 text-white text-[10px] font-bold uppercase rounded"
                                       href="@($"/quality?woId={wo.WorkOrderId}")">View</a>
                                    <button class="px-2 py-1 bg-[#243047] hover:bg-[#344465] border border-[#344465] text-slate-200 text-[10px] font-bold uppercase rounded"
                                            @onclick="() => DeleteQualityAsync(wo.WorkOrderId)">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            <div class="lg:col-span-4 bg-[#111621] border border-[#344465] overflow-hidden flex flex-col min-h-[320px]">
                <div class="p-3 border-b border-[#344465] bg-[#243047]/30 flex items-center justify-between">
                    <div class="text-xs font-bold uppercase tracking-wider text-slate-100 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm text-amber-400">lock</span>
                        Blocked Work Orders
                    </div>
                    <div class="text-[11px] text-slate-500">@_pmBlocked.Count</div>
                </div>
                <div class="flex-1 overflow-auto industrial-scrollbar p-3 space-y-2">
                    @if (_pmBlocked.Count == 0)
                    {
                        <div class="text-slate-500 text-sm p-4">No blocked work orders.</div>
                    }
                    else
                    {
                        @foreach (var wo in _pmBlocked.Take(30))
                        {
                            <div class="border border-amber-500/20 bg-amber-900/10 p-3">
                                <div class="flex items-center justify-between gap-3">
                                    <div class="min-w-0">
                                        <div class="text-xs font-bold text-amber-300 truncate">@wo.WorkOrderNumber</div>
                                        <div class="text-[11px] text-slate-500 mt-1">Current: <span class="text-slate-200 font-semibold">@wo.CurrentStage</span> · Gate: <span class="text-amber-300 font-semibold">@wo.CurrentGateStatus</span></div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <a class="px-2 py-1 bg-[#243047] hover:bg-[#344465] border border-[#344465] text-white text-[10px] font-bold uppercase rounded"
                                           href="@($"/quality?woId={wo.WorkOrderId}")">Open</a>
                                        <button class="px-2 py-1 bg-[#243047] hover:bg-[#344465] border border-[#344465] text-slate-200 text-[10px] font-bold uppercase rounded"
                                                @onclick="() => DeleteQualityAsync(wo.WorkOrderId)">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                                @if (wo.Blockers?.Count > 0)
                                {
                                    <div class="mt-2 text-[11px] text-slate-500">
                                        @string.Join(" · ", wo.Blockers.Take(3))
                                        @if (wo.Blockers.Count > 3) { <span> · +@(wo.Blockers.Count - 3) more</span> }
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        var chartData = _data?.Chart ?? new ChartDto(0, "Items", [new ChartBarDto("Total", 0, 100)]);
        var activities = _data?.Activities ?? [];
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-8 bg-[#243047]/20 border border-[#344465] flex flex-col">
                <div class="p-3 border-b border-[#344465] flex justify-between items-center bg-[#243047]/30">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-100 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">bar_chart</span>
                        Work Order Status Summary
                    </h3>
                </div>
                <div class="flex-1 p-6">
                    <div class="flex flex-col gap-2 mb-4">
                        <span class="text-3xl font-light text-slate-100 leading-none">@chartData.Total <small class="text-xs font-medium uppercase text-slate-500">@chartData.UnitLabel</small></span>
                    </div>
                    <div class="h-64 flex items-end justify-between gap-4 border-b border-l border-[#344465] pt-4 px-4">
                        @foreach (var bar in chartData.Bars)
                        {
                            <div class="flex flex-col items-center flex-1 group">
                                <div class="w-full bg-[#195de6]/30 border-t border-[#195de6]/50 flex flex-col justify-end group-hover:bg-[#195de6]/40 transition-all" style="height: @(bar.Height)%">
                                    <span class="text-[10px] text-center mb-1 text-slate-200 font-bold">@bar.Value</span>
                                </div>
                                <span class="text-[10px] font-medium text-slate-400 uppercase mt-2 tracking-tighter">@bar.Label</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 bg-[#111621] border border-[#344465] flex flex-col">
                <div class="p-3 border-b border-[#344465] flex justify-between items-center bg-[#243047]/40">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-100 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm text-[#195de6]">history</span>
                        Activity Log
                    </h3>
                    <span class="material-symbols-outlined text-slate-500 text-sm hover:text-white cursor-pointer" @onclick="RefreshAsync">refresh</span>
                </div>
                <div class="flex-1 overflow-y-auto industrial-scrollbar bg-[#0a0f18] font-mono text-[11px]">
                    @if (activities.Count == 0)
                    {
                        <div class="p-3 text-slate-500">No activity yet.</div>
                    }
                    else
                    {
                        @foreach (var entry in activities)
                        {
                            <div class="p-3 border-b border-[#344465]/30 hover:bg-[#243047]/10 transition-colors @entry.BgClass">
                                <div class="flex gap-2 @entry.TagColor mb-1">
                                    <span class="font-bold">[@entry.Time]</span>
                                    <span class="uppercase tracking-widest text-[9px] @entry.TagClass px-1 border @entry.TagBorder">@entry.Tag</span>
                                </div>
                                <div class="@entry.TextClass">@((MarkupString)entry.Message)</div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    }
    else if (role == "DispatchStoreManager")
    {
        <div class="bg-[#1a2233] border border-[#344465] mb-6">
            <div class="px-6 py-4 border-b border-[#344465] flex items-center justify-between gap-4">
                <div>
                    <div class="text-xs text-slate-400 uppercase tracking-widest font-bold">Store Manager</div>
                    <div class="text-xl font-bold text-white leading-none mt-1">Operations Overview</div>
                </div>
                <button class="bg-[#243047] hover:bg-[#344465] border border-[#344465] text-slate-300 py-2 px-4 text-xs font-bold rounded flex items-center gap-2" @onclick="RefreshAsync">
                    <span class="material-symbols-outlined text-sm">refresh</span> Refresh
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-[#243047]/25 border border-[#344465] p-4">
                <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500 mb-2">Low Stock Items</div>
                <div class="text-3xl font-light text-white">@_storeLowStockCount</div>
                <div class="text-[11px] text-slate-500 mt-1">Out of stock or below minimum level</div>
            </div>
            <div class="bg-[#243047]/25 border border-[#344465] p-4">
                <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500 mb-2">Pending SRS</div>
                <div class="text-3xl font-light text-white">@_storePendingSrsCount</div>
                <div class="text-[11px] text-slate-500 mt-1">Awaiting store approval + FIFO allocation</div>
            </div>
            <div class="bg-[#243047]/25 border border-[#344465] p-4">
                <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500 mb-2">Incoming Materials</div>
                <div class="text-3xl font-light text-white">@(_storeInventory?.IncomingOrderedQuantity ?? 0)</div>
                <div class="text-[11px] text-slate-500 mt-1">Ordered, not yet received</div>
            </div>
            <div class="bg-[#243047]/25 border border-[#344465] p-4">
                <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500 mb-2">Today’s GRNs</div>
                <div class="text-3xl font-light text-white">@_storeTodaysGrnCount</div>
                <div class="text-[11px] text-slate-500 mt-1">Receipts posted today</div>
            </div>
            <div class="bg-[#243047]/25 border border-[#344465] p-4">
                <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500 mb-2">Stock Summary</div>
                <div class="text-[11px] text-slate-400 mt-1">Avail: <span class="text-slate-200 font-semibold">@(_storeInventory?.TotalAvailable ?? 0)</span></div>
                <div class="text-[11px] text-slate-400 mt-1">Resv: <span class="text-slate-200 font-semibold">@(_storeInventory?.TotalReserved ?? 0)</span></div>
                <div class="text-[11px] text-slate-400 mt-1">Cons: <span class="text-slate-200 font-semibold">@(_storeInventory?.TotalConsumed ?? 0)</span></div>
            </div>
        </div>

        var activities = _data?.Activities ?? [];
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-7 bg-[#243047]/20 border border-[#344465] p-4">
                <div class="text-xs font-bold uppercase tracking-wider text-slate-100 flex items-center gap-2 mb-3">
                    <span class="material-symbols-outlined text-sm text-[#195de6]">inventory_2</span>
                    Today Snapshot
                </div>
                <div class="text-[11px] text-slate-500">
                    Use <span class="text-slate-200 font-semibold">Stock Overview</span>, <span class="text-slate-200 font-semibold">SRS</span>, and <span class="text-slate-200 font-semibold">GRN</span> from the left panel for operations.
                </div>
            </div>
            <div class="lg:col-span-5 bg-[#111621] border border-[#344465] flex flex-col overflow-hidden">
                <div class="p-3 border-b border-[#344465] flex justify-between items-center bg-[#243047]/40">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-100 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm text-[#195de6]">history</span>
                        Activity Log
                    </h3>
                    <span class="material-symbols-outlined text-slate-500 text-sm hover:text-white cursor-pointer" @onclick="RefreshAsync">refresh</span>
                </div>
                <div class="flex-1 overflow-y-auto industrial-scrollbar bg-[#0a0f18] font-mono text-[11px]">
                    @if (activities.Count == 0)
                    {
                        <div class="p-3 text-slate-500">No activity yet.</div>
                    }
                    else
                    {
                        @foreach (var entry in activities)
                        {
                            <div class="p-3 border-b border-[#344465]/30 hover:bg-[#243047]/10 transition-colors @entry.BgClass">
                                <div class="flex gap-2 @entry.TagColor mb-1">
                                    <span class="font-bold">[@entry.Time]</span>
                                    <span class="uppercase tracking-widest text-[9px] @entry.TagClass px-1 border @entry.TagBorder">@entry.Tag</span>
                                </div>
                                <div class="@entry.TextClass">@((MarkupString)entry.Message)</div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        var kpis = _data?.Kpis ?? [];
        var chartData = _data?.Chart ?? new ChartDto(0, "Items", [new ChartBarDto("Total", 0, 100)]);
        var activities = _data?.Activities ?? [];
        var approvals = _data?.Approvals ?? [];

        <!-- KPI Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
            @foreach (var kpi in kpis)
            {
                <div class="bg-[#243047]/50 border border-[#344465] p-4 group hover:border-[#195de6] transition-colors cursor-default">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">@kpi.Title</span>
                        <span class="material-symbols-outlined @kpi.IconColor text-lg">@kpi.Icon</span>
                    </div>
                    <div class="flex items-end gap-2">
                        <span class="text-2xl font-bold @kpi.ValueColor leading-none">@kpi.Value</span>
                        <span class="text-[10px] @kpi.ChangeColor font-bold leading-none mb-1">@kpi.Change</span>
                    </div>
                </div>
            }
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left: Chart -->
            <div class="lg:col-span-8 bg-[#243047]/20 border border-[#344465] flex flex-col">
                <div class="p-3 border-b border-[#344465] flex justify-between items-center bg-[#243047]/30">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-100 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">bar_chart</span>
                        @GetChartTitle()
                    </h3>
                    <div class="flex gap-2">
                        <button class="text-[10px] font-bold px-2 py-1 bg-[#195de6] text-white uppercase tracking-tighter">Current</button>
                        <button class="text-[10px] font-bold px-2 py-1 bg-[#243047] text-slate-400 uppercase tracking-tighter border border-[#344465]">Weekly</button>
                    </div>
                </div>
                <div class="flex-1 p-6">
                    <div class="flex flex-col gap-2 mb-4">
                        <span class="text-3xl font-light text-slate-100 leading-none">@chartData.Total <small class="text-xs font-medium uppercase text-slate-500">@chartData.UnitLabel</small></span>
                    </div>
                    <div class="h-64 flex items-end justify-between gap-4 border-b border-l border-[#344465] pt-4 px-4">
                        @foreach (var bar in chartData.Bars)
                        {
                            <div class="flex flex-col items-center flex-1 group">
                                <div class="w-full bg-[#195de6]/30 border-t border-[#195de6]/50 flex flex-col justify-end group-hover:bg-[#195de6]/40 transition-all" style="height: @(bar.Height)%">
                                    <span class="text-[10px] text-center mb-1 text-slate-200 font-bold">@bar.Value</span>
                                </div>
                                <span class="text-[10px] font-medium text-slate-400 uppercase mt-2 tracking-tighter">@bar.Label</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Right: Activity Log -->
            <div class="lg:col-span-4 bg-[#111621] border border-[#344465] flex flex-col">
                <div class="p-3 border-b border-[#344465] flex justify-between items-center bg-[#243047]/40">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-100 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm text-[#195de6]">history</span>
                        Activity Log
                    </h3>
                    <span class="material-symbols-outlined text-slate-500 text-sm hover:text-white cursor-pointer" @onclick="RefreshAsync">refresh</span>
                </div>
                <div class="flex-1 overflow-y-auto industrial-scrollbar bg-[#0a0f18] font-mono text-[11px]">
                    @if (activities.Count == 0)
                    {
                        <div class="p-3 text-slate-500">No activity yet.</div>
                    }
                    else
                    {
                        @foreach (var entry in activities)
                        {
                            <div class="p-3 border-b border-[#344465]/30 hover:bg-[#243047]/10 transition-colors @entry.BgClass">
                                <div class="flex gap-2 @entry.TagColor mb-1">
                                    <span class="font-bold">[@entry.Time]</span>
                                    <span class="uppercase tracking-widest text-[9px] @entry.TagClass px-1 border @entry.TagBorder">@entry.Tag</span>
                                </div>
                                <div class="@entry.TextClass">@((MarkupString)entry.Message)</div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Pending Approvals Table -->
        <div class="grid grid-cols-12 gap-6 mt-6">
            <div class="col-span-12 bg-[#243047]/20 border border-[#344465] overflow-hidden">
                <div class="p-3 border-b border-[#344465] flex justify-between items-center bg-[#243047]/30">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-100 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">assignment_turned_in</span>
                        Critical Pending Approvals
                    </h3>
                    <a href="#" class="text-[10px] font-bold text-[#195de6] flex items-center gap-1 hover:underline">VIEW ALL QUEUE <span class="material-symbols-outlined text-sm">arrow_forward</span></a>
                </div>
                <table class="w-full text-left border-collapse">
                    <thead>
                    <tr class="bg-[#111621]/50 border-b border-[#344465] text-[10px] uppercase font-bold text-slate-500">
                        <th class="px-4 py-3">ID #</th>
                        <th class="px-4 py-3">Module</th>
                        <th class="px-4 py-3">Originator</th>
                        <th class="px-4 py-3">Created</th>
                        <th class="px-4 py-3">Value</th>
                        <th class="px-4 py-3 text-right">Action</th>
                    </tr>
                    </thead>
                    <tbody class="text-xs text-slate-300 font-medium">
                    @if (approvals.Count == 0)
                    {
                        <tr><td colspan="6" class="px-4 py-6 text-center text-slate-500">No pending approvals.</td></tr>
                    }
                    else
                    {
                        @foreach (var item in approvals)
                        {
                            <tr class="border-b border-[#344465]/30 hover:bg-[#243047]/30 transition-colors group">
                                <td class="px-4 py-3 font-bold text-[#195de6]">@item.Id</td>
                                <td class="px-4 py-3"><span class="px-2 py-0.5 bg-[#243047] border border-[#344465] uppercase text-[9px]">@item.Module</span></td>
                                <td class="px-4 py-3 italic text-slate-400">@item.Originator</td>
                                <td class="px-4 py-3">@item.Created</td>
                                <td class="px-4 py-3">@item.Value</td>
                                <td class="px-4 py-3 text-right">
                                    <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button class="px-2 py-1 bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] uppercase font-bold">Approve</button>
                                        <button class="px-2 py-1 bg-rose-600 hover:bg-rose-500 text-white text-[10px] uppercase font-bold">Reject</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    </tbody>
                </table>
            </div>
        </div>
    }
}

@code {
    private DashboardResponse? _data;
    private bool _loading = true;
    private List<WorkOrderCardDto> _pmAllSent = [];
    private int _pmNewCount;
    private int _pmAcceptedCount;
    private int _pmAllSentCount;
    private int _pmActiveProductionCount;
    private List<QualityQueueItemDto> _pmAwaitingQc = [];
    private List<QualityQueueItemDto> _pmFailedOpenNcr = [];
    private List<QualityQueueItemDto> _pmBlocked = [];
    private string? _pmQualityDeleteError;

    private InventorySummaryDto? _storeInventory;
    private int _storeLowStockCount;
    private int _storePendingSrsCount;
    private int _storeTodaysGrnCount;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task DeleteQualityAsync(Guid workOrderId)
    {
        _pmQualityDeleteError = null;
        var (ok, err) = await Api.DeleteWorkOrderQualityAsync(Auth.BaseUrl, workOrderId);
        if (!ok) _pmQualityDeleteError = err ?? "Failed to delete quality records.";

        var queues = await Api.GetProductionManagerQualityQueuesAsync(Auth.BaseUrl, limit: 800);
        _pmAwaitingQc = queues?.AwaitingQc?.ToList() ?? [];
        _pmFailedOpenNcr = queues?.FailedQcOpenNcr?.ToList() ?? [];
        _pmBlocked = queues?.BlockedWorkOrders?.ToList() ?? [];
        StateHasChanged();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        StateHasChanged();

        var role = Auth.CurrentUser?.Role ?? "";
        var baseUrl = Auth.BaseUrl;
        _data = await Api.GetDashboardAsync(baseUrl, role);

        if (role == "ProductionManager")
        {
            var (sent, _) = await Api.GetWorkOrdersWithErrorAsync(baseUrl,
                sentToProduction: true,
                limit: 800);
            _pmAllSent = (sent ?? [])
                .OrderByDescending(x => x.SentToProductionAt)
                .ToList();

            _pmNewCount = _pmAllSent.Count(x => x.ProductionReceivedAt == null);
            _pmAcceptedCount = _pmAllSent.Count(x => x.ProductionReceivedAt != null);
            _pmAllSentCount = _pmAllSent.Count;

            var prod = await Api.GetProductionWorkOrdersAsync(baseUrl, stage: null);
            _pmActiveProductionCount = prod?.Count ?? 0;

            var queues = await Api.GetProductionManagerQualityQueuesAsync(baseUrl, limit: 800);
            _pmAwaitingQc = queues?.AwaitingQc?.ToList() ?? [];
            _pmFailedOpenNcr = queues?.FailedQcOpenNcr?.ToList() ?? [];
            _pmBlocked = queues?.BlockedWorkOrders?.ToList() ?? [];
        }
        else if (role == "DispatchStoreManager")
        {
            // Load store KPIs from existing endpoints.
            _storeInventory = await Api.GetInventorySummaryAsync(baseUrl);

            var pendingSrsTask = Api.GetSrsListAsync(baseUrl, status: "Pending", limit: 500);

            // Count GRNs for "today" using local day boundaries, converted to UTC (DB stores UTC).
            var localNow = DateTime.Now;
            var fromUtc = localNow.Date.ToUniversalTime();
            var toUtc = localNow.Date.AddDays(1).ToUniversalTime();
            var todaysGrnsTask = Api.GetGrnsAsync(baseUrl, limit: 500, from: fromUtc, to: toUtc);

            // Low stock count: compute from (MaterialVariants + material tree available totals).
            var variantsTask = Api.GetMaterialVariantsAsync(baseUrl);
            var treeTask = Api.GetInventoryMaterialTreeAsync(baseUrl);

            await Task.WhenAll(pendingSrsTask, todaysGrnsTask, variantsTask, treeTask);

            var pendingSrs = pendingSrsTask.Result ?? [];
            _storePendingSrsCount = pendingSrs.Count;

            var todaysGrns = todaysGrnsTask.Result ?? [];
            _storeTodaysGrnCount = todaysGrns.Count;

            var variants = variantsTask.Result ?? [];
            var tree = treeTask.Result ?? [];

            var availableByVariant = new Dictionary<Guid, decimal>();
            foreach (var t in tree)
            {
                foreach (var g in t.Grades)
                {
                    foreach (var v in g.Variants)
                    {
                        availableByVariant[v.Id] = v.Available;
                    }
                }
            }

            _storeLowStockCount = variants.Count(v =>
            {
                var avail = availableByVariant.TryGetValue(v.Id, out var a) ? a : 0;
                if (avail <= 0) return true;
                if (v.MinimumStockLevel > 0 && avail < v.MinimumStockLevel) return true;
                return false;
            });
        }

        _loading = false;
        StateHasChanged();
    }

    private async Task RefreshAsync()
    {
        await LoadAsync();
    }

    private string GetChartTitle()
    {
        var role = Auth.CurrentUser?.Role ?? "";
        return role is "CRMManager" or "CRMStaff" ? "Enquiry & Order Pipeline" : "Work Order Status Summary";
    }
}
