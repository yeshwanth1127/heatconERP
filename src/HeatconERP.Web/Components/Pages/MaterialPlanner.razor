@page "/material-planner"
@using HeatconERP.Web.Services
@using HeatconERP.Web.Models
@inject AuthService Auth
@inject ApiClient Api

<PageTitle>Material Planner - HeatconERP</PageTitle>

<div class="bg-[#1a2233] border border-[#344465] px-6 py-3 flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
        <h1 class="text-xl font-bold text-white leading-none">Material Planner</h1>
        <span class="bg-[#195de6]/20 text-[#195de6] text-[10px] font-bold px-2 py-0.5 rounded tracking-widest uppercase">Production</span>
    </div>
    <button class="bg-[#243047] hover:bg-[#344465] border border-[#344465] text-slate-300 py-1.5 px-4 text-xs font-bold rounded flex items-center gap-2" @onclick="LoadAsync">
        <span class="material-symbols-outlined text-sm">refresh</span> Refresh
    </button>
</div>

@if (_loading)
{
    <div class="p-8 text-slate-400">Loading...</div>
}
else
{
    <div class="bg-[#111621] border border-[#344465] p-4 mb-4">
        <label class="text-[10px] uppercase tracking-wider font-bold text-slate-500 block mb-1">Select Work Order</label>
        <select class="w-full bg-[#243047] border border-[#344465] rounded text-xs py-2 text-slate-200" @bind="_selectedWorkOrderId" @bind:after="OnWorkOrderChangedAsync">
            <option value="">-- Select Work Order --</option>
            @foreach (var wo in _workOrders)
            {
                <option value="@wo.Id">@wo.OrderNumber</option>
            }
        </select>
        <div class="text-[11px] text-slate-500 mt-2">
            Use this page to plan materials and raise SRS. Store Manager approves and allocates FIFO.
        </div>
    </div>

    <div class="bg-[#111621] border border-[#344465] p-4 mb-4">
        <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
                <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500">SRS for selected Work Order</div>
                <div class="text-[11px] text-slate-500 mt-1">This list is loaded from the database and persists after refresh.</div>
            </div>
            <button class="px-3 py-2 bg-[#243047] hover:bg-[#344465] border border-[#344465] text-slate-300 text-xs font-bold rounded flex items-center gap-2"
                    @onclick="LoadSrsForSelectedWoAsync"
                    disabled="@_srsLoading">
                <span class="material-symbols-outlined text-sm">refresh</span>
                <span>@(_srsLoading ? "Loading..." : "Refresh")</span>
            </button>
        </div>

        @if (!string.IsNullOrWhiteSpace(_srsError))
        {
            <div class="mt-3 p-3 border border-rose-500/20 bg-rose-900/15 text-rose-300 text-xs">@_srsError</div>
        }
        else if (!_selectedWorkOrderId.HasValue)
        {
            <div class="mt-3 text-xs text-slate-500">Select a work order to see its SRS.</div>
        }
        else if (_srsLoading)
        {
            <div class="mt-3 text-xs text-slate-500">Loading…</div>
        }
        else if (_srsForSelectedWo.Count == 0)
        {
            <div class="mt-3 text-xs text-slate-500">No SRS raised yet for this work order.</div>
        }
        else
        {
            <div class="mt-3 space-y-2">
                @foreach (var s in _srsForSelectedWo)
                {
                    <div class="flex items-center justify-between gap-3 bg-[#243047]/20 border border-[#344465] rounded p-2">
                        <div class="min-w-0">
                            <div class="text-xs font-bold text-slate-200">SRS-@s.Id.ToString()[..8]</div>
                            <div class="text-[11px] text-slate-500">@s.CreatedAt.ToLocalTime().ToString("dd MMM HH:mm")</div>
                        </div>
                        <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded border border-white/10 bg-[#243047]/60 text-slate-200">
                            @s.Status
                        </span>
                    </div>
                }
            </div>
        }
    </div>

    <div class="bg-[#111621] border border-[#344465] p-4 mb-4">
        <div class="flex flex-wrap items-end justify-between gap-3">
            <div class="min-w-0">
                <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500">Materials</div>
                <div class="text-xs text-slate-300 mt-1">Select variants and required quantity.</div>
            </div>
            <div class="flex items-center gap-2">
                <input class="bg-[#243047] border border-[#344465] rounded text-xs py-2 px-2 text-slate-200 w-[320px]"
                       placeholder="Search type / SKU / grade / size"
                       @bind="_search" @bind:after="ApplyFilter" />
                <button class="px-3 py-2 bg-[#195de6] hover:bg-[#195de6]/90 text-white text-xs font-bold rounded"
                        @onclick="RaiseSrsAsync"
                        disabled="@_raisingSrs">
                    @(_raisingSrs ? "Raising..." : "Raise SRS")
                </button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(_error))
        {
            <div class="mt-3 p-3 border border-rose-500/20 bg-rose-900/15 text-rose-300 text-xs">@_error</div>
        }
        @if (!string.IsNullOrEmpty(_success))
        {
            <div class="mt-3 p-3 border border-emerald-500/20 bg-emerald-900/10 text-emerald-300 text-xs">@_success</div>
        }
    </div>

    @if (_treeFiltered == null)
    {
        <div class="p-8 text-center text-slate-500 text-sm">Loading materials...</div>
    }
    else
    {
        <div class="space-y-4">
            @foreach (var type in _treeFiltered)
            {
                <div class="bg-[#111621] border border-[#344465] overflow-hidden">
                    <div class="p-4 border-b border-[#344465] bg-[#243047]/30 flex items-start justify-between gap-4">
                        <div class="min-w-0">
                            <div class="text-sm font-bold text-slate-100">@type.Name</div>
                            @if (!string.IsNullOrWhiteSpace(type.Description))
                            {
                                <div class="text-[11px] text-slate-500 mt-1 truncate">@type.Description</div>
                            }
                        </div>
                        <div class="shrink-0 text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded bg-[#243047]/60 border border-white/10 text-slate-300">
                            @type.Grades.Sum(g => g.Variants.Count) variants
                        </div>
                    </div>
                    <div class="p-4 space-y-3">
                        @foreach (var grade in type.Grades)
                        {
                            <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500">@grade.Grade</div>
                            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                                @foreach (var v in grade.Variants)
                                {
                                    var qty = _qty.GetValueOrDefault(v.Id);
                                    <div class="border border-[#344465] bg-[#243047]/15 p-4">
                                        <div class="text-xs font-bold text-[#195de6] truncate">@v.SKU</div>
                                        <div class="text-[11px] text-slate-400 mt-1 truncate">@v.Grade · @v.Size · @v.Unit</div>
                                        <div class="mt-3 grid grid-cols-2 gap-2 text-[11px]">
                                            <div class="bg-[#111621] border border-[#344465] p-2">
                                                <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500">Available</div>
                                                <div class="font-bold text-slate-200">@v.Available</div>
                                            </div>
                                            <div class="bg-[#111621] border border-[#344465] p-2">
                                                <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500">Reserved</div>
                                                <div class="font-bold text-slate-200">@v.Reserved</div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <label class="text-[10px] uppercase tracking-wider font-bold text-slate-500 block mb-1">Required Qty</label>
                                            <input type="number" step="0.01"
                                                   class="w-full bg-[#243047] border border-[#344465] rounded text-xs py-2 px-2 text-slate-200"
                                                   value="@qty"
                                                   @onchange="@((ChangeEventArgs e) => SetQty(v.Id, e.Value))" />
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
}

@code {
    private bool _loading = true;
    private bool _raisingSrs;
    private string? _error;
    private string? _success;

    private List<WorkOrderCardDto> _workOrders = [];
    private Guid? _selectedWorkOrderId;

    private bool _srsLoading;
    private string? _srsError;
    private List<SrsListDto> _srsForSelectedWo = [];

    private string _search = "";
    private List<MaterialTypeNodeDto>? _tree;
    private List<MaterialTypeNodeDto>? _treeFiltered;
    private readonly Dictionary<Guid, decimal> _qty = new();

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        _loading = true;
        _error = null;
        _success = null;
        StateHasChanged();

        var (wos, woErr) = await Api.GetWorkOrdersWithErrorAsync(Auth.BaseUrl, sentToProduction: true, productionReceived: null, limit: 800);
        _workOrders = (wos ?? []).OrderByDescending(x => x.SentToProductionAt).ToList();
        if (!string.IsNullOrEmpty(woErr)) _error = woErr;

        _tree = (await Api.GetInventoryMaterialTreeAsync(Auth.BaseUrl))?.ToList() ?? [];
        ApplyFilter();

        await LoadSrsForSelectedWoAsync();

        _loading = false;
        StateHasChanged();
    }

    private async Task OnWorkOrderChangedAsync()
    {
        await LoadSrsForSelectedWoAsync();
    }

    private async Task LoadSrsForSelectedWoAsync()
    {
        _srsError = null;
        _srsForSelectedWo = [];

        if (!_selectedWorkOrderId.HasValue) { StateHasChanged(); return; }

        _srsLoading = true;
        StateHasChanged();
        try
        {
            var list = await Api.GetSrsListAsync(Auth.BaseUrl, workOrderId: _selectedWorkOrderId.Value, limit: 50);
            _srsForSelectedWo = list?.OrderByDescending(x => x.CreatedAt).ToList() ?? [];
        }
        catch (Exception ex)
        {
            _srsError = ex.Message;
        }
        finally
        {
            _srsLoading = false;
            StateHasChanged();
        }
    }

    private void ApplyFilter()
    {
        if (_tree == null) { _treeFiltered = null; return; }
        var s = _search.Trim();
        if (string.IsNullOrWhiteSpace(s)) { _treeFiltered = _tree; return; }

        var filtered = new List<MaterialTypeNodeDto>();
        foreach (var t in _tree)
        {
            var typeMatch = t.Name.Contains(s, StringComparison.OrdinalIgnoreCase) || (t.Description?.Contains(s, StringComparison.OrdinalIgnoreCase) ?? false);
            var grades = new List<MaterialGradeNodeDto>();
            foreach (var g in t.Grades)
            {
                var vars = g.Variants
                    .Where(v => v.SKU.Contains(s, StringComparison.OrdinalIgnoreCase)
                                || v.Grade.Contains(s, StringComparison.OrdinalIgnoreCase)
                                || v.Size.Contains(s, StringComparison.OrdinalIgnoreCase))
                    .ToList();
                if (typeMatch) vars = g.Variants.ToList();
                if (vars.Count > 0) grades.Add(new MaterialGradeNodeDto(g.Grade, vars));
            }
            if (typeMatch && grades.Count == 0) grades = t.Grades.ToList();
            if (grades.Count > 0) filtered.Add(new MaterialTypeNodeDto(t.Id, t.Name, t.Description, grades));
        }
        _treeFiltered = filtered;
    }

    private void SetQty(Guid variantId, object? value)
    {
        if (value == null) { _qty.Remove(variantId); return; }
        if (decimal.TryParse(value.ToString(), out var qty) && qty > 0) _qty[variantId] = qty;
        else _qty.Remove(variantId);
    }

    private async Task RaiseSrsAsync()
    {
        _error = null;
        _success = null;

        if (!_selectedWorkOrderId.HasValue)
        {
            _error = "Select a work order first.";
            return;
        }

        var lines = _qty.Where(kv => kv.Value > 0).Select(kv => new CreateSrsLine(kv.Key, kv.Value)).ToList();
        if (lines.Count == 0)
        {
            _error = "Select at least one material and enter required quantity.";
            return;
        }

        _raisingSrs = true;
        StateHasChanged();
        try
        {
            var (srs, err) = await Api.CreateSrsAsync(Auth.BaseUrl, new CreateSrsRequest(_selectedWorkOrderId.Value, lines));
            if (srs == null)
            {
                _error = err ?? "Failed to create SRS.";
                return;
            }
            _success = $"SRS created: SRS-{srs.Id.ToString()[..8]} (Status: {srs.Status}). Store Manager can approve from SRS tab.";
            _qty.Clear();
            await LoadSrsForSelectedWoAsync();
        }
        finally
        {
            _raisingSrs = false;
            StateHasChanged();
        }
    }
}


