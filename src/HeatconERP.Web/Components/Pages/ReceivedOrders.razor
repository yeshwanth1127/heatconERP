@page "/received-orders"
@using HeatconERP.Web.Services
@using HeatconERP.Web.Models
@inject AuthService Auth
@inject ApiClient Api

<PageTitle>Received Orders - HeatconERP</PageTitle>

<div class="-m-6 flex flex-col min-h-[calc(100vh-5.5rem)]">
    <main class="flex-1 flex flex-col overflow-hidden">
        <div class="bg-[#1a2233] border-b border-[#344465] px-6 py-3 flex flex-wrap items-center justify-between gap-4 shrink-0">
            <div class="flex items-center gap-3">
                <h1 class="text-xl font-bold text-white leading-none">Received Orders</h1>
                <span class="bg-[#195de6]/20 text-[#195de6] text-[10px] font-bold px-2 py-0.5 rounded tracking-widest uppercase">From CRM</span>
            </div>
            <div class="flex items-center gap-2">
                <button class="bg-[#243047] hover:bg-[#344465] border border-[#344465] text-slate-300 py-1.5 px-4 text-xs font-bold rounded flex items-center gap-2" @onclick="LoadAsync">
                    <span class="material-symbols-outlined text-sm">refresh</span> Refresh
                </button>
            </div>
        </div>

        <div class="flex-1 flex overflow-hidden min-h-0">
            <section class="w-[520px] shrink-0 flex flex-col overflow-hidden border-r border-[#344465]">
                <div class="p-3 bg-[#111621]/50 border-b border-[#344465] shrink-0">
                    <div class="flex gap-2">
                        <button type="button"
                                class="px-3 py-1.5 text-[11px] font-bold uppercase tracking-wider border rounded
                                       @( _filter == InboxFilter.New ? "bg-[#195de6] text-white border-[#195de6]" : "bg-[#243047]/40 text-slate-300 border-[#344465] hover:bg-[#243047]")"
                                @onclick="@(() => SetFilter(InboxFilter.New))">
                            New (@_newCount)
                        </button>
                        <button type="button"
                                class="px-3 py-1.5 text-[11px] font-bold uppercase tracking-wider border rounded
                                       @( _filter == InboxFilter.Accepted ? "bg-[#195de6] text-white border-[#195de6]" : "bg-[#243047]/40 text-slate-300 border-[#344465] hover:bg-[#243047]")"
                                @onclick="@(() => SetFilter(InboxFilter.Accepted))">
                            Accepted (@_acceptedCount)
                        </button>
                        <button type="button"
                                class="px-3 py-1.5 text-[11px] font-bold uppercase tracking-wider border rounded
                                       @( _filter == InboxFilter.All ? "bg-[#195de6] text-white border-[#195de6]" : "bg-[#243047]/40 text-slate-300 border-[#344465] hover:bg-[#243047]")"
                                @onclick="@(() => SetFilter(InboxFilter.All))">
                            All (@_allCount)
                        </button>
                    </div>
                    <div class="mt-3">
                        <label class="text-[10px] uppercase tracking-wider font-bold text-slate-500">Search</label>
                        <input class="w-full bg-[#243047] border border-[#344465] rounded text-xs py-2 px-2 text-slate-200" placeholder="WO / Invoice / Part" @bind="_search" @bind:after="ApplyFilter" />
                    </div>
                </div>

                <div class="flex-1 overflow-auto industrial-scrollbar min-h-0">
                    @if (_loading)
                    {
                        <div class="flex items-center justify-center p-12 text-slate-400">Loading...</div>
                    }
                    else
                    {
                        @if (!string.IsNullOrEmpty(_listError))
                        {
                            <div class="p-4 text-red-400 text-xs border-b border-[#344465] bg-[#111621]/60">
                                @_listError
                            </div>
                        }

                        <div class="p-4 space-y-3">
                            @if (_inbox.Count == 0)
                            {
                                <div class="px-4 py-10 text-center text-slate-500 text-xs">No received orders.</div>
                            }
                            else
                            {
                                @foreach (var wo in _inbox)
                                {
                                    var isSelected = wo.Id == _selectedId;
                                    var lines = wo.LineItems?.ToList() ?? [];
                                    var totalQty = lines.Sum(x => x.Quantity);
                                    var preview = lines.Take(3).ToList();
                                    var remaining = Math.Max(0, lines.Count - preview.Count);

                                    <button type="button"
                                            class="w-full text-left rounded-xl p-4 border transition-all
                                                   backdrop-blur-md bg-white/5 hover:bg-white/10
                                                   shadow-[0_10px_30px_-12px_rgba(0,0,0,0.75)]
                                                   @(isSelected ? "border-[#195de6]/70 ring-1 ring-[#195de6]/30" : "border-white/10 hover:border-white/20")"
                                            @onclick="@(() => Select(wo.Id))">
                                        <div class="flex items-start justify-between gap-3">
                                            <div class="min-w-0">
                                                <div class="text-sm font-bold text-[#195de6] truncate">@wo.OrderNumber</div>
                                                <div class="mt-1 flex flex-wrap gap-2">
                                                    <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded bg-[#243047]/60 border border-white/10 text-slate-300">
                                                        Invoice: @(wo.PurchaseInvoiceNumber ?? "—")
                                                    </span>
                                                    <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded bg-[#243047]/60 border border-white/10 text-slate-400">
                                                        Qty: @totalQty
                                                    </span>
                                                    @if (wo.ProductionReceivedAt != null)
                                                    {
                                                        <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded bg-emerald-600/15 border border-emerald-500/20 text-emerald-300">
                                                            Accepted
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded bg-amber-600/15 border border-amber-500/20 text-amber-300">
                                                            New
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="shrink-0 text-[10px] text-slate-500">
                                                @if (wo.SentToProductionAt != null)
                                                {
                                                    <div class="text-right">
                                                        <div class="uppercase font-bold tracking-wider">Sent</div>
                                                        <div>@wo.SentToProductionAt.Value.ToLocalTime().ToString("dd MMM HH:mm")</div>
                                                    </div>
                                                }
                                            </div>
                                        </div>

                                        <div class="mt-3 border-t border-white/10 pt-3">
                                            @foreach (var li in preview)
                                            {
                                                <div class="flex items-center justify-between gap-3 text-[11px]">
                                                    <div class="min-w-0 text-slate-300 truncate">
                                                        <span class="font-semibold">@li.PartNumber</span>
                                                        @if (!string.IsNullOrWhiteSpace(li.Description))
                                                        {
                                                            <span class="text-slate-500"> – @li.Description</span>
                                                        }
                                                    </div>
                                                    <div class="shrink-0 text-slate-200 font-bold px-2 py-0.5 rounded bg-[#243047]/60 border border-white/10">
                                                        Qty @li.Quantity
                                                    </div>
                                                </div>
                                            }
                                            @if (remaining > 0)
                                            {
                                                <div class="text-[11px] text-slate-500 mt-1">+@remaining more items</div>
                                            }
                                        </div>
                                    </button>
                                }
                            }
                        </div>
                    }
                </div>
            </section>

            <aside class="flex-1 flex flex-col overflow-hidden bg-[#111621]">
                @if (_selected == null)
                {
                    <div class="p-8 text-center text-slate-500 text-sm">Select a received order to view details.</div>
                }
                else
                {
                    <div class="p-4 border-b border-[#344465] bg-[#243047]/30 flex items-center justify-between gap-3">
                        <div class="min-w-0">
                            <div class="text-xs font-bold text-[#195de6] uppercase tracking-wider truncate">@_selected.OrderNumber</div>
                            <div class="text-[11px] text-slate-400 mt-1">Invoice: @(_selected.PurchaseInvoiceNumber ?? "—")</div>
                        </div>
                        <div class="flex items-center gap-2 shrink-0">
                            <button class="bg-[#243047] hover:bg-[#344465] border border-[#344465] text-slate-200 py-2 px-3 text-xs font-bold rounded flex items-center gap-2"
                                    @onclick="OpenMaterialCheck">
                                <span class="material-symbols-outlined text-sm">inventory_2</span>
                                Check Material Availability
                            </button>
                            @if (_selected.ProductionReceivedAt == null)
                            {
                                <button class="bg-emerald-600 hover:bg-emerald-700 text-white py-2 px-3 text-xs font-bold rounded flex items-center gap-2"
                                        @onclick="AcceptAsync"
                                        disabled="@_accepting">
                                    @if (_accepting) { <span>Accepting...</span> } else { <span class="material-symbols-outlined text-sm">check_circle</span> <span>Accept</span> }
                                </button>
                            }
                            else
                            {
                                <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-2 rounded bg-emerald-600/15 border border-emerald-500/20 text-emerald-300">
                                    Accepted
                                </span>
                            }
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto industrial-scrollbar p-4 space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-[#243047]/20 border border-[#344465] p-3">
                                <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500 mb-1">Stage</div>
                                <div class="text-sm font-bold text-slate-200">@_selected.Stage</div>
                            </div>
                            <div class="bg-[#243047]/20 border border-[#344465] p-3">
                                <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500 mb-1">Status</div>
                                <div class="text-sm font-bold text-slate-200">@_selected.Status</div>
                            </div>
                        </div>

                        <div class="bg-[#243047]/20 border border-[#344465] p-3">
                            <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500 mb-2">Line Items</div>
                            @if (_selected.LineItems == null || _selected.LineItems.Count == 0)
                            {
                                <div class="text-xs text-slate-500">No line items.</div>
                            }
                            else
                            {
                                <table class="w-full border-collapse text-[11px]">
                                    <thead>
                                    <tr class="text-slate-500 border-b border-[#344465]">
                                        <th class="text-left py-1 pr-2">Part / Desc</th>
                                        <th class="text-right py-1 w-16">Qty</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    @foreach (var li in _selected.LineItems)
                                    {
                                        <tr class="border-b border-[#344465]/30">
                                            <td class="py-1 pr-2 text-slate-300">@li.PartNumber @(string.IsNullOrEmpty(li.Description) ? "" : " – " + li.Description)</td>
                                            <td class="text-right py-1 font-bold text-slate-200">@li.Quantity</td>
                                        </tr>
                                    }
                                    </tbody>
                                </table>
                            }
                        </div>

                        <div class="bg-[#243047]/20 border border-[#344465] p-3">
                            <div class="flex items-center justify-between gap-3 mb-2">
                                <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500">SRS (for this Work Order)</div>
                                <button class="text-[10px] font-bold text-slate-300 hover:text-white bg-[#1a2233] hover:bg-[#243047] border border-[#344465] rounded px-2 py-1 flex items-center gap-1"
                                        type="button"
                                        @onclick="ReloadSrsAsync"
                                        disabled="@_srsLoading">
                                    <span class="material-symbols-outlined text-sm">refresh</span>
                                    <span>@(_srsLoading ? "Loading..." : "Refresh")</span>
                                </button>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(_srsError))
                            {
                                <div class="text-[11px] text-rose-300">@_srsError</div>
                            }
                            else if (_srsLoading)
                            {
                                <div class="text-[11px] text-slate-500">Loading SRS…</div>
                            }
                            else if (_srsForSelectedWo.Count == 0)
                            {
                                <div class="text-[11px] text-slate-500">No SRS raised yet for this work order.</div>
                            }
                            else
                            {
                                <div class="space-y-2">
                                    @foreach (var s in _srsForSelectedWo)
                                    {
                                        <div class="flex items-center justify-between gap-3 bg-[#111621]/40 border border-[#344465]/50 rounded p-2">
                                            <div class="min-w-0">
                                                <div class="text-[11px] text-slate-200 font-semibold">SRS-@s.Id.ToString()[..8]</div>
                                                <div class="text-[10px] text-slate-500 mt-0.5">@s.CreatedAt.ToLocalTime().ToString("dd MMM HH:mm")</div>
                                            </div>
                                            <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded border border-white/10 bg-[#243047]/60 text-slate-200">
                                                @s.Status
                                            </span>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <div class="p-4 border-t border-[#344465] bg-[#243047]/30">
                        @if (!string.IsNullOrEmpty(_acceptError))
                        {
                            <p class="text-red-400 text-xs">@_acceptError</p>
                        }
                        @if (_acceptSuccess)
                        {
                            <p class="text-emerald-400 text-xs">Accepted successfully.</p>
                        }
                    </div>
                }
            </aside>
        </div>
    </main>
</div>

@if (_showMaterialModal && _selected != null)
{
    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50" @onclick="CloseMaterialCheck">
        <div class="bg-[#1a2233] border border-[#344465] rounded-lg shadow-2xl w-full max-w-5xl m-4" @onclick:stopPropagation="true">
            <div class="p-4 border-b border-[#344465] flex items-center justify-between">
                <div>
                    <div class="text-xs font-bold uppercase tracking-wider text-slate-200">Material Availability Check</div>
                    <div class="text-[11px] text-slate-400 mt-1">Work Order: <span class="text-slate-200 font-semibold">@_selected.OrderNumber</span></div>
                </div>
                <button class="p-2 text-slate-400 hover:text-white" @onclick="CloseMaterialCheck" type="button">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-4 space-y-3">
                <div class="bg-[#111621] border border-[#344465] p-4">
                    <div class="flex flex-wrap items-end justify-between gap-3">
                        <div class="min-w-0">
                            <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500">Select materials for SRS</div>
                            <div class="text-xs text-slate-300 mt-1">Choose variants and required quantity. Store will approve and allocate FIFO.</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input class="bg-[#243047] border border-[#344465] rounded text-xs py-2 px-2 text-slate-200 w-[320px]"
                                   placeholder="Search type / SKU / grade / size"
                                   @bind="_materialSearch" @bind:after="ApplyMaterialFilter" />
                            <button class="px-3 py-2 bg-[#195de6] hover:bg-[#195de6]/90 text-white text-xs font-bold rounded"
                                    @onclick="RaiseSrsAsync"
                                    disabled="@_raisingSrs">
                                @(_raisingSrs ? "Raising..." : "Raise SRS")
                            </button>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(_materialError))
                    {
                        <div class="mt-3 p-3 border border-rose-500/20 bg-rose-900/15 text-rose-300 text-xs">@_materialError</div>
                    }
                    @if (!string.IsNullOrEmpty(_materialSuccess))
                    {
                        <div class="mt-3 p-3 border border-emerald-500/20 bg-emerald-900/10 text-emerald-300 text-xs">@_materialSuccess</div>
                    }
                </div>

                @if (_materialTreeFiltered == null)
                {
                    <div class="p-8 text-center text-slate-500 text-sm">Loading materials...</div>
                }
                else if (_materialTreeFiltered.Count == 0)
                {
                    <div class="p-8 text-center text-slate-500 text-sm">No materials found.</div>
                }
                else
                {
                    <div class="space-y-4 max-h-[60vh] overflow-auto industrial-scrollbar pr-1">
                        @foreach (var type in _materialTreeFiltered)
                        {
                            <div class="bg-[#111621] border border-[#344465] overflow-hidden">
                                <div class="p-4 border-b border-[#344465] bg-[#243047]/30 flex items-start justify-between gap-4">
                                    <div class="min-w-0">
                                        <div class="text-sm font-bold text-slate-100">@type.Name</div>
                                        @if (!string.IsNullOrWhiteSpace(type.Description))
                                        {
                                            <div class="text-[11px] text-slate-500 mt-1 truncate">@type.Description</div>
                                        }
                                    </div>
                                    <div class="shrink-0 text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded bg-[#243047]/60 border border-white/10 text-slate-300">
                                        @type.Grades.Sum(g => g.Variants.Count) variants
                                    </div>
                                </div>

                                <div class="p-4 space-y-3">
                                    @foreach (var grade in type.Grades)
                                    {
                                        <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500">@grade.Grade</div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                                            @foreach (var v in grade.Variants)
                                            {
                                                var qty = _selectedQty.GetValueOrDefault(v.Id);
                                                var status = v.Available <= 0 ? "Out" : "OK";
                                                var statusClass = status == "Out"
                                                    ? "bg-rose-600/15 text-rose-300 border border-rose-500/20"
                                                    : "bg-emerald-600/15 text-emerald-300 border border-emerald-500/20";

                                                <div class="border border-[#344465] bg-[#243047]/15 p-4">
                                                    <div class="flex items-start justify-between gap-3">
                                                        <div class="min-w-0">
                                                            <div class="text-xs font-bold text-[#195de6] truncate">@v.SKU</div>
                                                            <div class="text-[11px] text-slate-400 mt-1 truncate">@v.Grade · @v.Size · @v.Unit</div>
                                                        </div>
                                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold @statusClass">@status</span>
                                                    </div>

                                                    <div class="grid grid-cols-2 gap-2 mt-3 text-[11px]">
                                                        <div class="bg-[#111621] border border-[#344465] p-2">
                                                            <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500">Available</div>
                                                            <div class="font-bold text-slate-200">@v.Available</div>
                                                        </div>
                                                        <div class="bg-[#111621] border border-[#344465] p-2">
                                                            <div class="text-[10px] uppercase tracking-wider font-bold text-slate-500">Reserved</div>
                                                            <div class="font-bold text-slate-200">@v.Reserved</div>
                                                        </div>
                                                    </div>

                                                    <div class="mt-3">
                                                        <label class="text-[10px] uppercase tracking-wider font-bold text-slate-500 block mb-1">Required Qty</label>
                                                        <input type="number" step="0.01"
                                                               class="w-full bg-[#243047] border border-[#344465] rounded text-xs py-2 px-2 text-slate-200"
                                                               value="@qty"
                                                               @onchange="@((ChangeEventArgs e) => SetQty(v.Id, e.Value))" />
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
                <div class="flex justify-end gap-2">
                    <button class="px-3 py-2 bg-[#344465] hover:bg-[#243047] text-white text-xs font-bold rounded" @onclick="CloseMaterialCheck" type="button">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private enum InboxFilter { New, Accepted, All }

    private InboxFilter _filter = InboxFilter.New;
    private string _search = "";

    private bool _loading = true;
    private string? _listError;

    private List<WorkOrderCardDto> _all = [];
    private List<WorkOrderCardDto> _inbox = [];

    private int _newCount;
    private int _acceptedCount;
    private int _allCount;

    private Guid? _selectedId;
    private WorkOrderCardDto? _selected;

    private bool _accepting;
    private bool _acceptSuccess;
    private string? _acceptError;

    private bool _showMaterialModal;

    private string _materialSearch = "";
    private bool _raisingSrs;
    private string? _materialError;
    private string? _materialSuccess;
    private List<MaterialTypeNodeDto>? _materialTree;
    private List<MaterialTypeNodeDto>? _materialTreeFiltered;
    private readonly Dictionary<Guid, decimal> _selectedQty = new();

    private bool _srsLoading;
    private string? _srsError;
    private List<SrsListDto> _srsForSelectedWo = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        _listError = null;
        StateHasChanged();

        var (items, err) = await Api.GetWorkOrdersWithErrorAsync(Auth.BaseUrl,
            sentToProduction: true,
            productionReceived: null,
            limit: 800);

        _all = (items ?? [])
            .OrderByDescending(x => x.SentToProductionAt)
            .ToList();

        _listError = err;
        RecalcCounts();
        ApplyFilter();

        if (_selectedId.HasValue)
            _selected = _all.FirstOrDefault(x => x.Id == _selectedId.Value);
        if (_selected == null && _inbox.Count > 0)
            Select(_inbox[0].Id);

        _loading = false;
        StateHasChanged();
    }

    private void RecalcCounts()
    {
        _newCount = _all.Count(x => x.ProductionReceivedAt == null);
        _acceptedCount = _all.Count(x => x.ProductionReceivedAt != null);
        _allCount = _all.Count;
    }

    private void SetFilter(InboxFilter f)
    {
        _filter = f;
        ApplyFilter();
    }

    private void ApplyFilter()
    {
        IEnumerable<WorkOrderCardDto> q = _filter switch
        {
            InboxFilter.New => _all.Where(x => x.ProductionReceivedAt == null),
            InboxFilter.Accepted => _all.Where(x => x.ProductionReceivedAt != null),
            _ => _all
        };

        if (!string.IsNullOrWhiteSpace(_search))
        {
            var s = _search.Trim();
            q = q.Where(x =>
                x.OrderNumber.Contains(s, StringComparison.OrdinalIgnoreCase)
                || (x.PurchaseInvoiceNumber?.Contains(s, StringComparison.OrdinalIgnoreCase) ?? false)
                || (x.LineItems?.Any(li => li.PartNumber.Contains(s, StringComparison.OrdinalIgnoreCase)) ?? false));
        }

        _inbox = q.ToList();

        if (_selectedId.HasValue && !_inbox.Any(x => x.Id == _selectedId.Value))
        {
            _selectedId = null;
            _selected = null;
        }

        StateHasChanged();
    }

    private void Select(Guid id)
    {
        _selectedId = id;
        _selected = _all.FirstOrDefault(x => x.Id == id);
        _acceptSuccess = false;
        _acceptError = null;
        _ = LoadSrsForSelectedWoAsync();
        StateHasChanged();
    }

    private async Task ReloadSrsAsync()
    {
        await LoadSrsForSelectedWoAsync();
    }

    private async Task LoadSrsForSelectedWoAsync()
    {
        _srsError = null;
        _srsForSelectedWo = [];

        if (_selected == null) return;

        _srsLoading = true;
        StateHasChanged();
        try
        {
            var list = await Api.GetSrsListAsync(Auth.BaseUrl, workOrderId: _selected.Id, limit: 50);
            _srsForSelectedWo = list?.OrderByDescending(x => x.CreatedAt).ToList() ?? [];
        }
        catch (Exception ex)
        {
            _srsError = ex.Message;
        }
        finally
        {
            _srsLoading = false;
            StateHasChanged();
        }
    }

    private async Task AcceptAsync()
    {
        if (_selected == null) return;
        _accepting = true;
        _acceptSuccess = false;
        _acceptError = null;
        StateHasChanged();

        var (ok, err) = await Api.ReceiveWorkOrderByProductionAsync(Auth.BaseUrl, _selected.Id, Auth.CurrentUser?.Username);
        _accepting = false;

        if (!ok)
        {
            _acceptError = err ?? "Failed to accept work order.";
            StateHasChanged();
            return;
        }

        _acceptSuccess = true;
        await LoadAsync();
    }

    private void OpenMaterialCheck()
    {
        _materialError = null;
        _materialSuccess = null;
        _materialSearch = "";
        _selectedQty.Clear();
        _showMaterialModal = true;
        _ = LoadMaterialTreeAsync();
        StateHasChanged();
    }

    private void CloseMaterialCheck()
    {
        _showMaterialModal = false;
        _materialError = null;
        _materialSuccess = null;
        _materialTree = null;
        _materialTreeFiltered = null;
        StateHasChanged();
    }

    private async Task LoadMaterialTreeAsync()
    {
        _materialTree = (await Api.GetInventoryMaterialTreeAsync(Auth.BaseUrl))?.ToList() ?? [];
        ApplyMaterialFilter();
    }

    private void ApplyMaterialFilter()
    {
        if (_materialTree == null)
        {
            _materialTreeFiltered = null;
            return;
        }

        var s = _materialSearch.Trim();
        if (string.IsNullOrWhiteSpace(s))
        {
            _materialTreeFiltered = _materialTree;
            StateHasChanged();
            return;
        }

        var filtered = new List<MaterialTypeNodeDto>();
        foreach (var t in _materialTree)
        {
            var typeMatch = t.Name.Contains(s, StringComparison.OrdinalIgnoreCase) || (t.Description?.Contains(s, StringComparison.OrdinalIgnoreCase) ?? false);
            var grades = new List<MaterialGradeNodeDto>();
            foreach (var g in t.Grades)
            {
                var vars = g.Variants
                    .Where(v =>
                        v.SKU.Contains(s, StringComparison.OrdinalIgnoreCase)
                        || v.Grade.Contains(s, StringComparison.OrdinalIgnoreCase)
                        || v.Size.Contains(s, StringComparison.OrdinalIgnoreCase))
                    .ToList();
                if (typeMatch) vars = g.Variants.ToList();
                if (vars.Count > 0) grades.Add(new MaterialGradeNodeDto(g.Grade, vars));
            }
            if (typeMatch && grades.Count == 0) grades = t.Grades.ToList();
            if (grades.Count > 0) filtered.Add(new MaterialTypeNodeDto(t.Id, t.Name, t.Description, grades));
        }

        _materialTreeFiltered = filtered;
        StateHasChanged();
    }

    private void SetQty(Guid variantId, object? value)
    {
        if (value == null)
        {
            _selectedQty.Remove(variantId);
            return;
        }

        if (decimal.TryParse(value.ToString(), out var qty) && qty > 0)
            _selectedQty[variantId] = qty;
        else
            _selectedQty.Remove(variantId);
    }

    private async Task RaiseSrsAsync()
    {
        if (_selected == null) return;

        _materialError = null;
        _materialSuccess = null;
        _raisingSrs = true;
        StateHasChanged();

        try
        {
            var lines = _selectedQty
                .Where(kv => kv.Value > 0)
                .Select(kv => new CreateSrsLine(kv.Key, kv.Value))
                .ToList();

            if (lines.Count == 0)
            {
                _materialError = "Select at least one material and enter required quantity.";
                return;
            }

            var (srs, err) = await Api.CreateSrsAsync(Auth.BaseUrl, new CreateSrsRequest(_selected.Id, lines));
            if (srs == null)
            {
                _materialError = err ?? "Failed to create SRS.";
                return;
            }

            _materialSuccess = $"SRS created: SRS-{srs.Id.ToString()[..8]} (Status: {srs.Status}). Store Manager can approve from SRS tab.";
            _selectedQty.Clear();
            await LoadSrsForSelectedWoAsync();
        }
        finally
        {
            _raisingSrs = false;
            StateHasChanged();
        }
    }
}


