@page "/enquiries"
@using HeatconERP.Web.Services
@using HeatconERP.Web.Models
@inject AuthService Auth
@inject ApiClient Api
@inject NavigationManager Nav

<PageTitle>Enquiry Management Grid - HeatconERP</PageTitle>

<div class="-m-6 flex flex-col min-h-[calc(100vh-5.5rem)]">
    <main class="flex flex-1 overflow-hidden min-h-0">
        <!-- Left Pane: Filters -->
        <aside class="w-64 border-r border-[#344465] bg-[#111621]/50 flex flex-col shrink-0">
            <div class="p-4 border-b border-[#344465]">
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Grid Filters</h2>
                <!-- Sector Toggle -->
                <div class="flex flex-col gap-2 mb-6">
                    <label class="text-xs font-semibold text-slate-400 uppercase">Sector</label>
                    <div class="flex bg-[#243047] p-1 rounded border border-[#344465]">
                        <button class="flex-1 text-[11px] font-bold py-1.5 rounded transition-colors @(_filterSector == null ? "bg-[#195de6] text-white" : "text-slate-400 hover:text-slate-200")" @onclick="@(() => { _filterSector = null; _ = LoadAsync(); })">ALL</button>
                        <button class="flex-1 text-[11px] font-bold py-1.5 rounded transition-colors @(_filterSector == true ? "bg-[#195de6] text-white" : "text-slate-400 hover:text-slate-200")" @onclick="@(() => { _filterSector = true; _ = LoadAsync(); })">AERO</button>
                        <button class="flex-1 text-[11px] font-bold py-1.5 rounded transition-colors @(_filterSector == false ? "bg-[#195de6] text-white" : "text-slate-400 hover:text-slate-200")" @onclick="@(() => { _filterSector = false; _ = LoadAsync(); })">GENERAL</button>
                    </div>
                </div>
                <!-- Status Filter -->
                <div class="flex flex-col gap-2 mb-6">
                    <label class="text-xs font-semibold text-slate-400 uppercase">Enquiry Status</label>
                    <select class="bg-[#243047] border border-[#344465] text-sm rounded py-1.5 text-slate-200 focus:ring-[#195de6] w-full" @bind="_filterStatus" @bind:after="LoadAsync">
                        <option value="">All Active</option>
                        <option value="New">New Enquiry</option>
                        <option value="Under Review">Under Review</option>
                        <option value="Feasible">Feasible</option>
                        <option value="Not Feasible">Not Feasible</option>
                        <option value="Converted">Converted</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <!-- Date Range -->
                <div class="flex flex-col gap-2 mb-6">
                    <label class="text-xs font-semibold text-slate-400 uppercase">Date Range</label>
                    <div class="flex flex-col gap-2">
                        <input type="date" class="bg-[#243047] border border-[#344465] text-[11px] rounded py-1 text-slate-200 w-full" @bind="_dateFrom" @bind:format="yyyy-MM-dd" @bind:after="LoadAsync" />
                        <input type="date" class="bg-[#243047] border border-[#344465] text-[11px] rounded py-1 text-slate-200 w-full" @bind="_dateTo" @bind:format="yyyy-MM-dd" @bind:after="LoadAsync" />
                    </div>
                </div>
                <button class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-xs font-bold uppercase rounded text-slate-200 flex items-center justify-center gap-2 transition-colors" @onclick="ResetFilters">
                    <span class="material-symbols-outlined text-sm">filter_alt_off</span>
                    Reset Filters
                </button>
            </div>
            <div class="p-4 mt-auto">
                <div class="bg-[#195de6]/5 border border-[#195de6]/20 rounded p-3">
                    <p class="text-[11px] text-slate-400 leading-tight">System v1.0 - Active Node: <span class="text-[#195de6] font-mono">EN-US-01</span></p>
                </div>
            </div>
        </aside>

        <!-- Center Pane: Data Grid -->
        <section class="flex-1 flex flex-col min-w-0 bg-[#111621]">
            <div class="h-10 border-b border-[#344465] flex items-center justify-between px-4 bg-[#243047]/30 shrink-0">
                <div class="flex items-center gap-4">
                    <span class="text-xs font-medium text-slate-400">Total Enquiries: <span class="text-slate-100">@_enquiries.Count</span></span>
                    <span class="text-xs font-medium text-slate-400">Showing: <span class="text-slate-100">@_enquiries.Count</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <button class="px-3 py-1.5 bg-amber-600 hover:bg-amber-500 text-white text-xs font-bold uppercase rounded" @onclick="SeedAsync" disabled="@_seeding" title="Seed sample data">
                        @(_seeding ? "Seeding..." : "Seed Sample Data")
                    </button>
                    <button class="p-1 hover:bg-white/5 rounded text-slate-400" @onclick="LoadAsync" title="Refresh"><span class="material-symbols-outlined text-sm">refresh</span></button>
                </div>
            </div>
            <div class="flex-1 overflow-auto industrial-scrollbar">
                @if (_loading)
                {
                    <div class="flex items-center justify-center p-12 text-slate-400">Loading enquiries...</div>
                }
                else
                {
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead class="sticky top-0 bg-[#243047] z-10 border-b border-[#344465]">
                            <tr class="text-[11px] uppercase text-slate-500 font-bold">
                                <th class="px-4 py-3 border-r border-[#344465]">Enquiry ID</th>
                                <th class="px-4 py-3 border-r border-[#344465]">Customer</th>
                                <th class="px-4 py-3 border-r border-[#344465] text-center">Src</th>
                                <th class="px-4 py-3 border-r border-[#344465]">Feasibility</th>
                                <th class="px-4 py-3 border-r border-[#344465]">Priority</th>
                                <th class="px-4 py-3">Assigned Staff</th>
                            </tr>
                        </thead>
                        <tbody class="text-xs divide-y divide-[#344465]/50">
                            @if (_enquiries.Count == 0)
                                {
                                    <tr>
                                        <td colspan="6" class="px-4 py-8 text-center">
                                            <p class="text-slate-500 mb-2">No enquiries found.</p>
                                            <p class="text-slate-600 text-xs">Click <strong class="text-amber-400">Seed Sample Data</strong> above to load sample enquiries.</p>
                                        </td>
                                    </tr>
                                }
                            else
                            {
                                @foreach (var e in _enquiries)
                                {
                                    <tr class="hover:bg-white/5 cursor-pointer transition-colors @(e.Id == _selectedId ? "grid-row-selected" : "")" @onclick="@(() => SelectEnquiry(e.Id))">
                                        <td class="px-4 py-2 border-r border-[#344465] font-bold @(e.Id == _selectedId ? "text-[#195de6]" : "text-slate-300")">@e.EnquiryNumber</td>
                                        <td class="px-4 py-2 border-r border-[#344465]">@e.CompanyName</td>
                                        <td class="px-4 py-2 border-r border-[#344465] text-center">
                                            <span class="material-symbols-outlined text-sm text-slate-400">@GetSourceIcon(e.Source)</span>
                                        </td>
                                        <td class="px-4 py-2 border-r border-[#344465]">
                                            <span class="px-2 py-0.5 rounded-sm font-bold text-[10px] uppercase @GetFeasibilityClass(e.FeasibilityStatus)">@e.FeasibilityStatus</span>
                                        </td>
                                        <td class="px-4 py-2 border-r border-[#344465]">
                                            <div class="flex gap-0.5">
                                                @foreach (var dot in GetPriorityDotColors(e.Priority))
                                                {
                                                    <div class="w-2 h-2 rounded-full @dot"></div>
                                                }
                                            </div>
                                        </td>
                                        <td class="px-4 py-2 flex items-center gap-2">
                                            <div class="w-5 h-5 bg-slate-700 rounded-full flex items-center justify-center text-[10px] font-bold text-slate-400">@GetInitials(e.AssignedTo)</div>
                                            <span>@(e.AssignedTo ?? "Unassigned")</span>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                }
            </div>
        </section>

        <!-- Right Pane: Enquiry Detail -->
        <aside class="w-96 border-l border-[#344465] bg-[#243047] flex flex-col shrink-0">
            <div class="p-4 border-b border-[#344465] flex justify-between items-center bg-[#111621]/30 shrink-0">
                <h3 class="text-sm font-bold uppercase tracking-tight">Enquiry Detail</h3>
                <span class="text-[10px] bg-[#195de6] text-white px-2 py-0.5 font-bold rounded-sm uppercase">@(_selectedDetail != null ? "Active Record" : "No Selection")</span>
            </div>
            <div class="flex-1 overflow-y-auto industrial-scrollbar p-5">
                @if (_selectedDetail == null)
                {
                    <p class="text-sm text-slate-500 italic">Select an enquiry from the grid to view details.</p>
                }
                else
                {
                    <!-- Registration Verification (placeholder) -->
                    <div class="mb-8">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">verified_user</span>
                            Registration Verification
                        </h4>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 p-2 bg-[#111621] border border-[#344465] rounded cursor-pointer group">
                                <input type="checkbox" class="rounded border-slate-600 bg-transparent text-[#195de6] focus:ring-[#195de6] h-4 w-4" />
                                <span class="text-xs text-slate-200 group-hover:text-white transition-colors">AS9100 Certification Valid</span>
                            </label>
                            <label class="flex items-center gap-3 p-2 bg-[#111621] border border-[#344465] rounded cursor-pointer group">
                                <input type="checkbox" class="rounded border-slate-600 bg-transparent text-[#195de6] focus:ring-[#195de6] h-4 w-4" />
                                <span class="text-xs text-slate-200 group-hover:text-white transition-colors">ITAR Compliance Verified</span>
                            </label>
                            <label class="flex items-center gap-3 p-2 bg-[#111621] border border-[#344465] rounded cursor-pointer group">
                                <input type="checkbox" class="rounded border-slate-600 bg-transparent text-[#195de6] focus:ring-[#195de6] h-4 w-4" />
                                <span class="text-xs text-slate-200 group-hover:text-white transition-colors">Vendor Registration Form Received</span>
                            </label>
                        </div>
                    </div>
                    <!-- Feasibility Assessment -->
                    <div class="mb-8">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">description</span>
                            Feasibility Assessment
                        </h4>
                        <textarea class="w-full bg-[#111621] border border-[#344465] text-xs text-slate-100 rounded p-3 h-32 focus:ring-[#195de6] focus:border-[#195de6] resize-none placeholder:text-slate-600" placeholder="Enter technical feasibility notes, thermal requirements, and manufacturing constraints here..." @bind="_feasibilityNotes"></textarea>
                        <p class="text-[10px] text-slate-500 mt-2 italic">@(_selectedDetail.UpdatedAt.HasValue ? $"Last updated at {_selectedDetail.UpdatedAt.Value:yyyy-MM-dd HH:mm}" : $"Created at {_selectedDetail.CreatedAt:yyyy-MM-dd HH:mm}")</p>
                    </div>
                    <!-- Product Summary -->
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-[#111621] border border-[#344465] p-2 rounded">
                            <p class="text-[10px] text-slate-500 uppercase font-bold">Product</p>
                            <p class="text-sm text-slate-100 truncate" title="@_selectedDetail.ProductDescription">@(_selectedDetail.ProductDescription ?? "—")</p>
                        </div>
                        <div class="bg-[#111621] border border-[#344465] p-2 rounded">
                            <p class="text-[10px] text-slate-500 uppercase font-bold">Qty</p>
                            <p class="text-sm text-slate-100 font-mono">@(_selectedDetail.Quantity?.ToString() ?? "—")</p>
                        </div>
                    </div>
                }
            </div>
            @if (_selectedDetail != null)
            {
                <div class="p-4 bg-[#111621]/80 border-t border-[#344465] space-y-2 shrink-0">
                    @if (!string.IsNullOrEmpty(_convertError))
                    {
                        <p class="text-xs text-red-400 mb-2">@_convertError</p>
                    }
                    <button type="button" class="w-full py-3 bg-[#195de6] hover:bg-[#195de6]/90 text-white text-xs font-bold uppercase tracking-wider rounded shadow-lg shadow-[#195de6]/20 transition-all flex items-center justify-center gap-2 disabled:opacity-50" @onclick="ConvertToQuotation" disabled="@(_converting || _isConverted)">
                        <span class="material-symbols-outlined text-lg">description</span>
                        @(_converting ? "Creating..." : _isConverted ? "Already Converted" : "Convert to Quotation")
                    </button>
                    <button class="w-full py-2 bg-transparent border border-red-500/50 hover:bg-red-500/10 text-red-500 text-xs font-bold uppercase tracking-wider rounded transition-all">
                        Mark Not Feasible
                    </button>
                </div>
            }
        </aside>
    </main>
</div>

@code {
    private List<EnquiryListDto> _enquiries = [];
    private EnquiryDetailDto? _selectedDetail;
    private Guid? _selectedId;
    private string _filterStatus = "";
    private bool? _filterSector = null;
    private DateTime? _dateFrom;
    private DateTime? _dateTo;
    private bool _loading = true;
    private bool _seeding;
    private bool _converting;
    private string _convertError = "";
    private bool _isConverted => _selectedDetail?.Status == "Converted";
    private string _feasibilityNotes = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        StateHasChanged();
        var baseUrl = Auth.BaseUrl;
        var items = await Api.GetEnquiriesAsync(baseUrl,
            string.IsNullOrEmpty(_filterStatus) ? null : _filterStatus,
            _filterSector,
            _dateFrom,
            _dateTo);
        _enquiries = items?.ToList() ?? [];
        _loading = false;
        if (_selectedId.HasValue && !_enquiries.Any(e => e.Id == _selectedId.Value))
            _selectedId = null;
        if (_selectedId.HasValue)
            await LoadDetailAsync(_selectedId.Value);
        StateHasChanged();
    }

    private async Task SelectEnquiry(Guid id)
    {
        _selectedId = id;
        _feasibilityNotes = "";
        _convertError = "";
        await LoadDetailAsync(id);
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadDetailAsync(Guid id)
    {
        var detail = await Api.GetEnquiryByIdAsync(Auth.BaseUrl, id);
        if (detail != null)
        {
            _selectedDetail = detail;
            _feasibilityNotes = detail.FeasibilityNotes ?? "";
        }
        else
        {
            // Fallback: build minimal detail from list when API returns null (e.g. 404, network error)
            var listItem = _enquiries.FirstOrDefault(e => e.Id == id);
            _selectedDetail = listItem != null
                ? new EnquiryDetailDto(
                    listItem.Id, listItem.EnquiryNumber, listItem.DateReceived, listItem.Source, listItem.AssignedTo, listItem.Status,
                    listItem.CompanyName, null, null, null, null, null, listItem.ProductDescription, null, null, null,
                    listItem.IsAerospace, listItem.Priority, listItem.FeasibilityStatus, null,
                    null, listItem.DateReceived, null)
                : null;
            _feasibilityNotes = "";
        }
    }

    private void ResetFilters()
    {
        _filterStatus = "";
        _filterSector = null;
        _dateFrom = null;
        _dateTo = null;
        _ = LoadAsync();
    }

    private async Task ConvertToQuotation()
    {
        if (!_selectedId.HasValue) return;
        _convertError = "";
        _converting = true;
        await InvokeAsync(StateHasChanged);
        try
        {
            var created = await Api.CreateQuotationAsync(Auth.BaseUrl, _selectedId, Auth.CurrentUser?.Username);
            if (created != null)
            {
                await Auth.EnsureSessionPersistedAsync();
                Nav.NavigateTo($"/quotations?enquiry={_selectedId}", forceLoad: false);
            }
            else
                _convertError = "Failed to create quotation.";
        }
        catch (Exception ex)
        {
            _convertError = ex.Message;
        }
        finally
        {
            _converting = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SeedAsync()
    {
        _seeding = true;
        StateHasChanged();
        var ok = await Api.SeedEnquiriesAsync(Auth.BaseUrl);
        _seeding = false;
        if (ok) await LoadAsync();
        StateHasChanged();
    }

    private static string GetSourceIcon(string source) => source?.ToLowerInvariant() switch
    {
        "email" or "indiamart" => "mail",
        "whatsapp" => "chat",
        "phone" => "phone",
        _ => "edit_note"
    };

    private static string GetFeasibilityClass(string status) => status switch
    {
        "Feasible" => "bg-emerald-500/10 text-emerald-500 border border-emerald-500/20",
        "Not Feasible" => "bg-red-500/10 text-red-500 border border-red-500/20",
        "Pending" => "bg-slate-700/50 text-slate-500 border border-slate-700",
        _ => "bg-amber-500/10 text-amber-500 border border-amber-500/20"
    };

    private static string[] GetPriorityDotColors(string priority)
    {
        return priority switch
        {
            "High" => ["bg-red-500", "bg-red-500", "bg-red-500"],
            "Medium" => ["bg-amber-500", "bg-amber-500", "bg-slate-700"],
            _ => ["bg-slate-700", "bg-slate-700", "bg-slate-700"]
        };
    }

    private static string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2) return $"{parts[0][0]}{parts[^1][0]}".ToUpperInvariant();
        return name.Length >= 2 ? name[..2].ToUpperInvariant() : name.ToUpperInvariant();
    }
}
