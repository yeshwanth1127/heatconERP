@page "/quality"
@using HeatconERP.Web.Services
@using HeatconERP.Web.Models
@inject AuthService Auth
@inject ApiClient Api

<PageTitle>Quality Control - HeatconERP</PageTitle>

<div class="mb-6 flex items-center justify-between">
    <h2 class="text-lg font-bold uppercase tracking-wider text-slate-100 flex items-center gap-2">
        <span class="material-symbols-outlined text-[#195de6]">verified_user</span>
        Quality Control
    </h2>
    <div class="flex gap-2">
        <select class="bg-[#243047] border border-[#344465] text-slate-200 text-xs px-3 py-2 uppercase font-medium" @bind="_filterResult" @bind:after="LoadAsync">
            <option value="">All Results</option>
            <option value="Pass">Pass</option>
            <option value="Fail">Fail</option>
            <option value="Retest">Retest</option>
            <option value="Pending">Pending</option>
        </select>
        <button class="px-3 py-2 bg-[#195de6] text-white text-xs font-bold uppercase" @onclick="ToggleNewForm">
            <span class="material-symbols-outlined text-sm align-middle">add</span> New Inspection
        </button>
        <button class="px-3 py-2 bg-[#243047] border border-[#344465] text-slate-300 text-xs font-bold uppercase" @onclick="LoadAsync">
            <span class="material-symbols-outlined text-sm align-middle">refresh</span> Refresh
        </button>
    </div>
</div>

@if (_showNewForm)
{
    <div class="mb-6 bg-[#243047]/30 border border-[#344465] p-4">
        <h3 class="text-xs font-bold uppercase text-slate-300 mb-3">Record Inspection</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="text-[10px] text-slate-500 uppercase block mb-1">Work Order #</label>
                <input type="text" class="w-full bg-[#111621] border border-[#344465] px-3 py-2 text-slate-200 text-sm" @bind="_newWorkOrder" placeholder="e.g. WO-4400-01" />
            </div>
            <div>
                <label class="text-[10px] text-slate-500 uppercase block mb-1">Result</label>
                <select class="w-full bg-[#111621] border border-[#344465] px-3 py-2 text-slate-200 text-sm" @bind="_newResult">
                    <option value="Pass">Pass</option>
                    <option value="Fail">Fail</option>
                    <option value="Retest">Retest</option>
                    <option value="Pending">Pending</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="text-[10px] text-slate-500 uppercase block mb-1">Notes</label>
                <input type="text" class="w-full bg-[#111621] border border-[#344465] px-3 py-2 text-slate-200 text-sm" @bind="_newNotes" placeholder="Optional notes" />
            </div>
        </div>
        <div class="mt-3 flex gap-2">
            <button class="px-3 py-2 bg-emerald-600 text-white text-xs font-bold uppercase" @onclick="SubmitInspection">Submit</button>
            <button class="px-3 py-2 bg-[#243047] border border-[#344465] text-slate-300 text-xs font-bold uppercase" @onclick="ToggleNewForm">Cancel</button>
        </div>
    </div>
}

@if (_loading)
{
    <div class="flex items-center justify-center p-12 text-slate-400">Loading...</div>
}
else
{
    <div class="bg-[#243047]/20 border border-[#344465] overflow-hidden">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-[#111621]/50 border-b border-[#344465] text-[10px] uppercase font-bold text-slate-500">
                    <th class="px-4 py-3">Work Order</th>
                    <th class="px-4 py-3">Result</th>
                    <th class="px-4 py-3">Notes</th>
                    <th class="px-4 py-3">Inspected At</th>
                    <th class="px-4 py-3">Inspected By</th>
                </tr>
            </thead>
            <tbody class="text-xs text-slate-300">
                @if (_inspections.Count == 0)
                {
                    <tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">No inspections recorded.</td></tr>
                }
                else
                {
                    @foreach (var q in _inspections)
                    {
                        <tr class="border-b border-[#344465]/30 hover:bg-[#243047]/30 transition-colors">
                            <td class="px-4 py-3 font-bold text-[#195de6]">@q.WorkOrderNumber</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-0.5 uppercase text-[9px] font-bold @(q.Result == "Pass" ? "bg-emerald-900/40 text-emerald-400 border border-emerald-800" : q.Result == "Fail" ? "bg-rose-900/40 text-rose-400 border border-rose-800" : "bg-[#243047] text-slate-400 border border-[#344465]")">@q.Result</span>
                            </td>
                            <td class="px-4 py-3 text-slate-400">@(q.Notes ?? "--")</td>
                            <td class="px-4 py-3">@q.InspectedAt.ToString("yyyy-MM-dd HH:mm")</td>
                            <td class="px-4 py-3">@q.InspectedBy</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<QualityInspectionDto> _inspections = [];
    private string _filterResult = "";
    private bool _loading = true;
    private bool _showNewForm;
    private string _newWorkOrder = "";
    private string _newResult = "Pass";
    private string _newNotes = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        StateHasChanged();
        var baseUrl = Auth.BaseUrl;
        var items = await Api.GetQualityInspectionsAsync(baseUrl, string.IsNullOrEmpty(_filterResult) ? null : _filterResult);
        _inspections = items?.ToList() ?? [];
        _loading = false;
        StateHasChanged();
    }

    private void ToggleNewForm()
    {
        _showNewForm = !_showNewForm;
        if (!_showNewForm) { _newWorkOrder = ""; _newNotes = ""; _newResult = "Pass"; }
        StateHasChanged();
    }

    private async Task SubmitInspection()
    {
        if (string.IsNullOrWhiteSpace(_newWorkOrder)) return;
        var inspectedBy = Auth.CurrentUser?.Username ?? "System";
        var ok = await Api.CreateQualityInspectionAsync(Auth.BaseUrl, _newWorkOrder.Trim(), _newResult, string.IsNullOrWhiteSpace(_newNotes) ? null : _newNotes.Trim(), inspectedBy);
        if (ok)
        {
            _showNewForm = false;
            _newWorkOrder = "";
            _newNotes = "";
            await LoadAsync();
        }
    }
}
